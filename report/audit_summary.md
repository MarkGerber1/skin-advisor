# üîç –ê–£–î–ò–¢ –õ–û–ì–ò–ö–ò –ö–û–†–ó–ò–ù–´: –¢–ï–°–¢–´ ‚Üí –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ‚Üí –ö–û–†–ó–ò–ù–ê ‚Üí –û–§–û–†–ú–õ–ï–ù–ò–ï

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-01-01  
**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:** –ó–æ–ª–æ—Ç–æ–µ –Ø–±–ª–æ–∫–æ ‚Üí –†–æ—Å—Å–∏–π—Å–∫–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ ‚Üí –†–æ—Å—Å–∏–π—Å–∫–∏–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã ‚Üí –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ

## üìä –ö–†–ê–¢–ö–ò–ô –û–ë–ó–û–†

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ—Ä–∑–∏–Ω—ã
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- ‚ùå –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–æ—Ç—Ç–µ–Ω–æ–∫/–æ–±—ä—ë–º)
- ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –°–ò–°–¢–ï–ú–´ –ö–û–†–ó–ò–ù–´

### 1. –û—Å–Ω–æ–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (bot/handlers/cart.py + engine/cart_store.py)
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ  
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: `items[item.product_id].qty += item.qty`
- ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ JSON —Ñ–∞–π–ª–∞—Ö
- ‚úÖ Thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `threading.Lock()`
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ (brand, name, price, explain, etc.)
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤ (—Ä–∞–∑–º–µ—Ä, –æ—Ç—Ç–µ–Ω–æ–∫)
- ‚ùå –ù–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 2. –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (.skin-advisor/app/)
**–°—Ç–∞—Ç—É—Å:** –£—Å—Ç–∞—Ä–µ–≤—à–∞—è, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è  
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- ‚ùå –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç thread safety

## üõçÔ∏è –ê–ù–ê–õ–ò–ó –ü–û–¢–û–ö–ê "–¢–ï–°–¢–´ ‚Üí –ö–û–†–ó–ò–ù–ê"

### –≠—Ç–∞–ø 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
**–õ–æ–∫–∞—Ü–∏—è:** `bot/handlers/detailed_skincare.py`, `bot/handlers/detailed_palette.py`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Engine v2 SelectorV2
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ

### –≠—Ç–∞–ø 2: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π  
**–õ–æ–∫–∞—Ü–∏—è:** `bot/ui/render.py`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ "–í –∫–æ—Ä–∑–∏–Ω—É"
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ–∫—É–ø–∫—É
- ‚ùå –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–º–µ—é—Ç —Ä–∞–≤–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

### –≠—Ç–∞–ø 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
**–õ–æ–∫–∞—Ü–∏—è:** `bot/handlers/cart.py:add_to_cart()`
**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `product_id` –∏–∑ callback
2. –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö —á–µ—Ä–µ–∑ `_find_product_in_recommendations()`
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è (`in_stock`)
4. –°–æ–∑–¥–∞–Ω–∏–µ `CartItem` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `store.add()` —Å –∞–≤—Ç–æ—É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º qty

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ variant_id (–æ—Ç—Ç–µ–Ω–æ–∫, —Ä–∞–∑–º–µ—Ä)
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–∫–∞—Ö

### –≠—Ç–∞–ø 4: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–æ–π
**–§—É–Ω–∫—Ü–∏–∏:** show_cart, remove_from_cart, increase/decrease_quantity, buy_all_items
- ‚úÖ –ü–æ–ª–Ω—ã–π CRUD –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ Bulk –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫—É–ø–∏—Ç—å –≤—Å–µ)
- ‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
- ‚ùå –ù–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º

## üéØ –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø –ò–°–¢–û–ß–ù–ò–ö–û–í

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
- –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ
- ref_link –±–µ—Ä–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –±–µ–∑ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢—Ä–µ–±—É–µ–º–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è
1. **–ó–æ–ª–æ—Ç–æ–µ –Ø–±–ª–æ–∫–æ** (goldenappletree.ru, –∑–æ–ª–æ—Ç–æ–µ—è–±–ª–æ—á–∫–æ.—Ä—Ñ)
2. **–†–æ—Å—Å–∏–π—Å–∫–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ** (sephora.ru, letu.ru, rive-gauche.ru)
3. **–†–æ—Å—Å–∏–π—Å–∫–∏–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã** (wildberries.ru, ozon.ru, yandex.market.ru)
4. **–ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ** (sephora.com, ulta.com, etc.)

## üß™ –í–ê–†–ò–ê–ù–¢–´ –¢–û–í–ê–†–û–í

### –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- CartItem —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ product_id
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ variant_id  
- –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç—Ç–µ–Ω–∫–æ–≤, –æ–±—ä–µ–º–æ–≤, —Ä–∞–∑–º–µ—Ä–æ–≤

### –¢—Ä–µ–±—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```python
@dataclass
class CartItem:
    product_id: str
    variant_id: Optional[str] = None  # NEW: shade, size, volume
    qty: int = 1
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
```

## üìà –ò–î–ï–ú–ü–û–¢–ï–ù–¢–ù–û–°–¢–¨

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è product_id:**
```python
if item.product_id in items:
    items[item.product_id].qty += item.qty  # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ qty
else:
    items[item.product_id] = item  # –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
```

### –¢—Ä–µ–±—É–µ–º–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
```python
composite_key = f"{product_id}:{variant_id or 'default'}"
if composite_key in items:
    items[composite_key].qty += item.qty
else:
    items[composite_key] = item
```

## üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–í –ø—Ä–æ—Ü–µ—Å—Å–µ)
- [x] –ê—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è  
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
- [ ] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ

### –≠—Ç–∞–ø 2: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è SourcePrioritizer
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä –∏ render
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

### –≠—Ç–∞–ø 3: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ CartItem —Å variant_id
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏  
- [ ] UI –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

### –≠—Ç–∞–ø 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] End-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
