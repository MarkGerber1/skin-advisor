# ОТЧЁТ ОТ GPT‑5: Глубокий аудит Telegram‑бота Skin Advisor

Дата: 24 сентября 2025

## 1. Резюме (краткое)

Произведён полный технический и продуктовый аудит бота. Выявлены и приоритезированы проблемы; предложены решения с чёткими шагами внедрения и критериями приёмки. Основные выводы:

- Ключевые блоки проекта: единый `Dispatcher` с приоритетами роутеров, координатор состояний (FSM), «Корзина v2», селектор рекомендаций `SelectorV2`, рендер текстов и PDF‑отчёты, локализация, конфигурация окружения.
- Критические несоответствия API и несколько ошибок, влияющих на работу корзины, рекомендаций и PDF‑отчётов.
- Даны практические исправления уровня P0 (срочно) и план улучшений уровня P1–P2.

Основные P0‑исправления (срочно):

1) Правильная передача объекта бота в безопасное редактирование сообщений («Корзина v2»).
2) Кнопки «В корзину» строить по `product_id`, не зависеть от наличия ссылки.
3) Единый вызов `SelectorV2.select_products_v2(...)` с профилем пользователя и каталогом, вместо устаревших вызовов.
4) Приведение функций визуальной карточки PDF v2 к методам класса либо временное отключение вызова.

Ожидаемый эффект: стабильная работа корзины и рекомендаций, консистентные кнопки добавления, корректная генерация PDF, улучшенная надёжность.

## 2. Область аудита и методика

- Репозиторий: C:\Users\1\Desktop\chatbot-skincare
- Объекты: точка входа и инициализация бота; маршрутизация; FSM и восстановление; корзина v2; рекомендации и интерфейс; селектор; PDF‑генерация; локализация; конфигурация окружения; службы источников/партнёрских ссылок; диагностика и логирование.
- Метод: чтение исходного кода, сопоставление интерфейсов между слоями (handlers → services → engine), поиск несоответствий, формирование плана исправлений и улучшений.

## 3. Краткий обзор архитектуры

- Инициализация: `bot/main.py` — создание `Bot`, `Dispatcher`, подключение роутеров с заданным порядком приоритетов, запуск в webhook/polling, базовое глобальное обработчик ошибок.
- Маршрутизация: тематические роутеры (старт/меню, тесты, корзина v2, рекомендации, универсальные обработчики). Порядок приоритетов корректный: безопасность → админ → корзина/рекомендации → специализированные потоки → общий ловец.
- Состояния: координатор FSM предотвращает параллельные потоки и обеспечивает восстановление/очистку.
- Рекомендации: `SelectorV2` (Engine v2) формирует результаты по уходу и макияжу, ожидая профиль пользователя и каталог.
- Корзина v2: единый сервис хранения, управление количеством, итоги, оформление, аналитика событий.
- Интеграции: локализация (`i18n/ru.py`), конфигурация через `config/env.py`, источники/партнёрские ссылки, рендер UI, PDF‑отчёты.

## 4. Выявленные проблемы и решения

### Приоритет P0 (срочно)

1) Неверный вызов безопасного редактирования сообщений в «Корзина v2»
- Суть: функция безопасного редактирования сообщения требует передачу экземпляра бота как первого аргумента, но вызывается без него. Это приводит к ошибкам при попытках обновить сообщение корзины и нарушает работу интерфейса.
- Решение: во всех вызовах заменить `await safe_edit_message_text(chat_id, message_id, text, ...)` на `await safe_edit_message_text(cb.message.bot, chat_id, message_id, text, ...)` (или эквивалент с передачей бота из контекста).
- Критерий приёмки: все операции корзины (открыть, увеличить/уменьшить, удалить, очистить) обновляют сообщение без ошибок.

2) Кнопки «В корзину» зависят от наличия ссылки
- Суть: логика рендера кнопки «В корзину» требует существования `link/url/ref_link`, хотя корзина v2 работает по `product_id`. В результате часть товаров лишается кнопок.
- Решение: в генераторе кнопки отказаться от проверки ссылки. Кнопка «В корзину» должна создаваться при наличии `id`. Наличие ссылки использовать только для кнопок «Купить/Подробнее», но не для добавления в корзину.
- Критерий приёмки: в рекомендациях и отчётах все товары с `id` имеют кнопку добавления «В корзину».

3) Неправильные вызовы `SelectorV2` в рекомендациях и подборщиках
- Суть: используются устаревшие или неверные сигнатуры (например, `select_products(...)` без профиля и каталога). Это лишает персонализации и/или приводит к ошибкам и фолбэкам.
- Решение: привести все места к единой сигнатуре `select_products_v2(profile, catalog, partner_code, redirect_base)`. Профиль брать из хранилища профилей пользователя; каталог — через `CatalogStore.instance(settings.catalog_path)`; партнёрские параметры — из `config.env`.
- Критерий приёмки: рекомендации формируются персонально и повторяемо для одного и того же профиля вне зависимости от точки входа.

4) PDF v2: вызов метода вне класса
- Суть: в генераторе PDF v2 вызывается метод добавления визуальной карточки, который реализован как внешняя функция (не метод класса). Это может приводить к падению при генерации.
- Решение: перенести функции визуальной карточки и диаграмм внутрь класса `StructuredPDFGenerator` или временно отключить вызов до переноса.
- Критерий приёмки: генерация PDF v2 завершается без ошибок, файл создаётся и содержит ожидаемые разделы.

### Приоритет P1 (высокий)

5) Единый путь к каталогу
- Суть: местами путь к каталогу указан жёстко (например, `assets/fixed_catalog.yaml`), вместо использования настройки.
- Решение: централизовать через `get_settings().catalog_path`.
- Критерий приёмки: изменение пути в `.env` мгновенно отражается везде без правок кода.

6) Валюты и формат цены
- Суть: в рендере может использоваться `currency`, тогда как селектор отдаёт `price_currency`. Это порождает пустые/ошибочные обозначения валют.
- Решение: при вычислении строки цены использовать `price_currency` с фолбэком в `currency`; символ рубля выводить единообразно.
- Критерий приёмки: для всех товаров корректно отображаются цена и валюта.

7) Дублирующиеся константы локализации
- Суть: в `i18n/ru.py` продублированы некоторые константы, что повышает риск рассинхронизации текстов.
- Решение: оставить по одному определению на ключ; провести лёгкую ревизию на предмет дублей.
- Критерий приёмки: отсутствуют повторные определения одинаковых ключей.

### Приоритет P2 (средний/низкий)

8) Логирование через `print`
- Суть: повсеместное использование `print()` затрудняет фильтрацию и сопровождение.
- Решение: перейти на модуль `logging`, уровни — из настроек окружения.
- Критерий приёмки: раздельные потоки INFO/ERROR, настраиваемые уровни в `.env`.

9) Справочник источников и партнёрские ссылки
- Суть: разрозненные списки доменов и категоризации, возможны опечатки.
- Решение: унифицировать словарь доменов/категорий и приоритетов в одном месте; провести выверку доменных имён.
- Критерий приёмки: единая таблица доменов, отсутствие противоречий, предсказуемая приоритизация.

10) Кроссплатформенность служебных операций
- Суть: отдельные сценарии «убийства» процессов актуальны для Linux, но не для Windows; возможен шум в логах.
- Решение: условная активация платформенно‑зависимых блоков.
- Критерий приёмки: отсутствие лишних предупреждений на Windows, корректная работа в обоих окружениях.

## 5. План внедрения (по шагам)

P0 (сразу):
1) Исправить вызовы безопасного редактирования сообщений в «Корзина v2» (передача `bot`).
2) Убрать зависимость кнопки «В корзину» от наличия ссылок; строить по `id`.
3) Привести все вызовы `SelectorV2` к `select_products_v2(...)` с использованием профиля пользователя и каталога из настроек.
4) Привести функции PDF v2 к методам класса/отключить вызов временно.

P1:
5) Централизовать путь к каталогу через `config.env`.
6) Нормализовать валюту/формат цены в рендере.
7) Устранить дубли в локализации.

P2:
8) Перевести основное логирование с `print` на `logging`.
9) Унифицировать справочник источников/доменов.
10) Разделить платформенную логику служебных операций.

## 6. Критерии приёмки и тесты

- Корзина: все действия (открыть/добавить/изменить/удалить/очистить) выполняются без ошибок; сообщение корректно обновляется; итоговая сумма и количество соответствуют ожидаемым.
- Рекомендации: выдаются персонализированные подборки на основе последнего профиля; кнопки «В корзину» присутствуют для всех позиций с `id`.
- PDF v2: генерируется без ошибок; разделы и заголовки отображаются; при отсутствии визуальной карточки генерация не падает.
- Конфигурация: смена `catalog_path` в `.env` отражается во всех частях системы; логирование управляется уровнем из настроек.
- Локализация: отсутствуют дублирующиеся ключи; тексты единообразны.

## 7. Рекомендации по развитию функциональности

- Развитие корзины: отображение состояния «В корзине» с инкрементом количества; блок «Похожие товары»/«Альтернативы» для недоступных позиций; единый блок «Оформление» со сводным списком и приоритизацией источников.
- Персонализация: единый сервис рекомендаций (профиль → селектор → нормализация) для всех входных точек (меню, завершение теста, повторы); явные настройки предпочтений (финиш, покрытие, чувствительность).
- Аналитика: фиксация кликов по ключевым кнопкам («В корзину», «Оформление», «Похожие») и построение простых воронок.
- Отчёты: «лёгкая» версия PDF без внешних шрифтов/диаграмм для ограниченных окружений; добавление краткого чек‑листа ухода.
- Удобство использования: унификация подписей кнопок и разделов; устранение жаргона; понятные статусы и навигация.

## 8. Риски и меры снижения

- Несогласованность интерфейсов между слоями → регрессы. Мера: единый «RecommendationService», модульные тесты интерфейсов.
- Платформенные различия (Windows/Linux) → неодинаковое поведение служебных операций. Мера: условные ветки, отключение нерелевантных шагов на Windows.
- Неконсолидированные словари доменов → непредсказуемая приоритизация. Мера: единый справочник и проверка регулярными тестами.

## 9. Список ключевых мест кода (для ориентирования)

- Инициализация и запуск: `bot/main.py`
- Корзина v2: `bot/handlers/cart_v2.py`, `services/cart_store.py`
- Рекомендации: `bot/handlers/recommendations.py`, `engine/selector.py`, `engine/catalog_store.py`
- Рендер отчётов в чат: `bot/ui/render.py`
- PDF v2: `bot/ui/pdf_v2.py`, простой генератор: `bot/ui/pdf.py`
- Локализация: `i18n/ru.py`
- Конфигурация: `config/env.py`
- Безопасность и утилиты: `bot/utils/security.py`

## 10. Предлагаемые форматы коммитов и порядок внедрения

- Формат сообщений коммитов: `fix(scope): описание` для исправлений; `feat(scope): описание` для новых функций; `chore/docs/refactor` по необходимости.
- Порядок: отдельные малые коммиты по каждому пункту P0, затем P1 и P2. После каждого логического шага — локальная проверка и краткая запись в отчёт о выполнении.

## 11. Итог

Представленный план исправлений и улучшений устраняет текущие препятствия и повышает надёжность, предсказуемость и удобство использования. После внедрения P0 система стабильно покажет корректные рекомендации, позволит добавлять товары в корзину из всех точек и формировать PDF‑отчёты без ошибок. P1–P2 завершат консолидацию конфигураций, локализации и логирования.


