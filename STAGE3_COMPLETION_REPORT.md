# ‚úÖ –≠–¢–ê–ü 3 –ó–ê–í–ï–†–®–ï–ù: FSM –ò UX-–£–°–¢–û–ô–ß–ò–í–û–°–¢–¨

## üéØ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò

### ‚úÖ 1. –ó–∞–ø—Ä–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
**üìÅ –§–∞–π–ª:** `bot/handlers/fsm_coordinator.py`

**üîí –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- **FSMCoordinator** –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** `can_start_flow()` - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –≤—ã–±–æ—Ä: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å/–¥–æ–º–æ–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –∏—Å—Ç–µ–∫—à–∏—Ö —Å–µ–∞–Ω—Å–æ–≤ (30 –º–∏–Ω—É—Ç timeout)

**üí´ –†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–ª–∏—Ç—Ä—É + –∫–æ–∂—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### ‚úÖ 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–æ–≤
**üìÅ –§–∞–π–ª—ã:** `fsm_coordinator.py` + `start.py` (recovery handlers)

**üîÑ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **SessionData** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç: flow, step, progress, timestamp, flow_data
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ** - –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- **3 –æ–ø—Ü–∏–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:** –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å / –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ / –î–æ–º–æ–π
- **–ü—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** - –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤

**üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:**
```python
SessionData(
    user_id=12345,
    current_flow="detailed_palette",
    current_step="Q3_SKIN_UNDERTONE", 
    flow_data={"hair": "–±–ªond", "eyes": "blue"},
    flow_progress=0.375,  # 3/8 —à–∞–≥–æ–≤
    started_at=timestamp,
    last_activity=timestamp
)
```

### ‚úÖ 3. –ü–æ–¥—Å–∫–∞–∑–∫–∏ –≤ —à–∞–≥–∞—Ö
**üìÅ –§–∞–π–ª:** `bot/handlers/step_hints.py`

**üí° –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏:**
- **A1_UNDERTONE:** "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç–æ—Ä–æ–Ω—É –∑–∞–ø—è—Å—Ç—å—è –ø—Ä–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏"
- **Q3_SKIN_UNDERTONE:** "–í–µ–Ω—ã –Ω–∞ –∑–∞–ø—è—Å—Ç—å–µ: —Å–∏–Ω–∏–µ = —Ö–æ–ª–æ–¥–Ω—ã–π, –∑–µ–ª–µ–Ω—ã–µ = —Ç–µ–ø–ª—ã–π –ø–æ–¥—Ç–æ–Ω"
- **B2_CONCERNS:** "–ü—Ä–æ–±–ª–µ–º—ã –∫–æ–∂–∏ –ø–æ–º–æ–≥—É—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ü–µ–ª–µ–≤—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –Ω—É–∂–Ω—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏"

**üìä –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å:**
```
üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: 3/8 (37%) ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë
```

**üéØ –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
- –®–∞–≥ 1: "üöÄ –û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å —á–µ—Å—Ç–Ω–æ"
- –®–∞–≥ 3: "‚≠ê –í—ã —É–∂–µ –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø—É—Ç–∏! –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ"
- –®–∞–≥ 7+: "üèÜ –§–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è! –°–µ–π—á–∞—Å —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### 1. FSMCoordinator –∫–∞–∫ Singleton
```python
class FSMCoordinator:
    def __init__(self):
        self._active_sessions: Dict[int, SessionData] = {}
        self.flow_definitions = {
            "detailed_palette": {"steps": ["Q1_HAIR_COLOR", ...], "duration": "10-12 –º–∏–Ω—É—Ç"},
            "detailed_skincare": {"steps": ["Q1_TIGHTNESS", ...], "duration": "10-15 –º–∏–Ω—É—Ç"}
        }
```

### 2. Integration Points
- **start.py handlers** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- **recovery callbacks** - `recovery:continue`, `recovery:restart:flow_name`, `recovery:home`
- **step tracking** - –∫–∞–∂–¥—ã–π handler –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ coordinator

### 3. UX Protection
- **Anti-parallel** - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Session timeout** - 30 –º–∏–Ω—É—Ç –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
- **Graceful recovery** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ª—é–±–æ–≥–æ —à–∞–≥–∞
- **Progress indication** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å

## üìä –£–õ–£–ß–®–ï–ù–ò–Ø UX

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚ùå –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–ª–∏—Ç—Ä—É + –∫–æ–∂—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚ùå –ü—Ä–∏ –æ–±—Ä—ã–≤–µ —Ç–µ—Å—Ç–∞ - –Ω–∞—á–∏–Ω–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞
- ‚ùå –ù–µ–ø–æ–Ω—è—Ç–Ω–æ –∑–∞—á–µ–º –Ω—É–∂–µ–Ω –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å
- ‚ùå –ù–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚úÖ **Single flow** - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–µ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ **Session recovery** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ **Step hints** - –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏ –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
- ‚úÖ **Progress tracking** - –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å + –º–æ—Ç–∏–≤–∞—Ü–∏—è
- ‚úÖ **Timeout handling** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ–∞–Ω—Å–æ–≤

## üéØ –ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–ï–ú–ö–ò - –í–´–ü–û–õ–ù–ï–ù–´

- ‚úÖ **–ó–∞–ø—Ä–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤** - FSMCoordinator –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞** - SessionData + recovery callbacks
- ‚úÖ **–ü–æ–¥—Å–∫–∞–∑–∫–∏ –≤ —à–∞–≥–∞—Ö** - 15+ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
- ‚úÖ **UX —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - –ø—Ä–æ–≥—Ä–µ—Å—Å, –º–æ—Ç–∏–≤–∞—Ü–∏—è, timeout protection
- ‚úÖ **Graceful error handling** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

## üöÄ –ì–û–¢–û–í–û –ö –≠–¢–ê–ü–£ 4

**FSM —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç–æ–π—á–∏–≤–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –æ—à–∏–±–∫–∞–º.**  
**UX –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç —Ç–µ—Å—Ç—ã —á–∞—â–µ.**

---

### –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏
- AFFILIATE_TAG –≤–æ –≤—Å–µ—Ö —Å—Å—ã–ª–∫–∞—Ö
- –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ (CTR, CR, –≤—Ä–µ–º—è)
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

*–°—Ç–∞—Ç—É—Å: –≠–¢–ê–ü 3 –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù ‚úÖ*






