# Коммиты для создания системы инлайн-подбора ухода

## Коммит 1: feat(source): priority GA→RU official→RU MP→INTL + alternatives
### Файлы:
- `engine/source_resolver.py` - НОВЫЙ файл с системой приоритизации источников

### Описание:
- Создана система приоритизации источников: Золотое Яблоко (1) → RU официальные (2) → RU маркетплейсы (3) → Зарубежные (4)
- Добавлена функция `resolve_source()` для определения источника товара
- Реализован поиск альтернатив для недоступных товаров
- Добавлена функция `enhance_product_with_source_info()` для обогащения товаров информацией об источнике

## Коммит 2: feat(analytics): events for skincare inline flow
### Файлы:
- `engine/analytics.py` - ОБНОВЛЕН с новыми функциями аналитики

### Описание:
- Добавлены функции для отслеживания инлайн-потока подбора ухода:
  - `track_skincare_recommendations_viewed()`
  - `track_category_opened()`
  - `track_product_opened()`
  - `track_variant_selected()`
  - `track_oos_shown()`
  - `track_alternatives_shown()`
  - `track_skincare_error()`
- Обновлена интеграция аналитики в `skincare_picker.py`

## Коммит 3: chore(copy): i18n строки и короткие подписи
### Файлы:
- `i18n/ru.py` - ОБНОВЛЕН с новыми строками локализации

### Описание:
- Добавлены строки для подбора ухода:
  - `HEAD_SKINCARE_PICK` - заголовок блока
  - `SUB_PICK` - подзаголовок
  - Кнопки категорий: `BTN_CLEANSE`, `BTN_TONE`, etc.
  - Действия: `BTN_ADD_TO_CART`, `BTN_CHOOSE_VARIANT`, etc.
  - Источники: `SRC_GOLDAPPLE`, `SRC_RU_OFFICIAL`, etc.
  - Сообщения: `MSG_ADDED`, `MSG_VARIANT_ADDED`, etc.
- Добавлены слаги категорий для callback'ов

## Коммит 4: feat(skincare): inline подбор и доб. в корзину после теста
### Файлы:
- `bot/handlers/skincare_picker.py` - НОВЫЙ файл с логикой подбора
- `bot/main.py` - ОБНОВЛЕН с новым роутером
- `bot/handlers/detailed_skincare.py` - ОБНОВЛЕН с новой кнопкой

### Описание:
- Создан полный модуль инлайн-подбора ухода после теста "Портрет лица"
- Реализованы категории товаров с пагинацией
- Добавлена поддержка вариантов товаров
- Интегрирована система корзины с валидацией
- Добавлена приоритизация источников
- Реализована защита от двойного клика (debounce)
- Добавлен поиск альтернатив для OOS товаров
- Интегрирована полная аналитика всех действий пользователя

## Финальный коммит: feat(cart): idempotent add + validate variant
### Файлы:
- Все файлы системы корзины уже обновлены в предыдущих коммитах

### Описание:
- Идемпотентность добавления товаров в корзину
- Валидация принадлежности variant_id к product_id
- Уникальность строки корзины по ключу (product_id + variant_id)
- Защита от двойного клика на уровне сервиса корзины




