–†–∞–¥, —á—Ç–æ –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º\! –ú—ã –Ω–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø—Ä—è–º–æ–π.

–í–æ—Ç —Å–ª–µ–¥—É—é—â–∞—è, —Å–∞–º–∞—è –æ–±—ä–µ–º–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞: –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (`domain`), –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (`ui`) –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ (`handlers`).

### **PROJECT FILES (Continued)**

#### **\# FILE: .skin-advisor/app/domain/diagnosis.py**

```python
from collections import defaultdict

def diagnose_skin(answers: dict) -> dict:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –∞–Ω–∫–µ—Ç—ã –∏ –≤—ã–Ω–æ—Å–∏—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ç–∏–ø–æ–º –∫–æ–∂–∏, —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º.
    """
    type_scores = defaultdict(int)
    state_scores = defaultdict(int)
    reasoning = []

    # Q1: –°—Ç—è–Ω—É—Ç–æ—Å—Ç—å –ø–æ—Å–ª–µ —É–º—ã–≤–∞–Ω–∏—è (—Å—É—Ö–æ—Å—Ç—å/–æ–±–µ–∑–≤–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)
    if answers.get('Q1') == 'Q1_A1':
        type_scores['—Å—É—Ö–∞—è'] += 2
        state_scores['–æ–±–µ–∑–≤–æ–∂–µ–Ω–Ω–æ—Å—Ç—å'] += 2
        reasoning.append("–û—â—É—â–µ–Ω–∏–µ —Å—Ç—è–Ω—É—Ç–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —É–º—ã–≤–∞–Ω–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –≤–ª–∞–≥–∏ –∏–ª–∏ –ª–∏–ø–∏–¥–æ–≤.")

    # Q2: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–∂–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è
    if answers.get('Q2') == 'Q2_A1': # –ë–ª–µ—Å–∫ —á–µ—Ä–µ–∑ 2-3 —á–∞—Å–∞
        type_scores['–∂–∏—Ä–Ω–∞—è'] += 3
        reasoning.append("–ë—ã—Å—Ç—Ä–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∂–∏—Ä–Ω–æ–≥–æ –±–ª–µ—Å–∫–∞ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–∑–Ω–∞–∫ –∂–∏—Ä–Ω–æ–π –∫–æ–∂–∏.")
    elif answers.get('Q2') == 'Q2_A2': # –ë–ª–µ—Å–∫ –∫ –≤–µ—á–µ—Ä—É
        type_scores['–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è'] += 1
        type_scores['–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'] += 1
    elif answers.get('Q2') == 'Q2_A3': # –°—Ç—è–Ω—É—Ç–æ—Å—Ç—å –∫ –æ–±–µ–¥—É
        type_scores['—Å—É—Ö–∞—è'] += 2
        state_scores['–æ–±–µ–∑–≤–æ–∂–µ–Ω–Ω–æ—Å—Ç—å'] += 2
        reasoning.append("–ü–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ç—è–Ω—É—Ç–æ—Å—Ç–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –≥–æ–≤–æ—Ä–∏—Ç –æ –Ω–µ—Ö–≤–∞—Ç–∫–µ —É–≤–ª–∞–∂–Ω–µ–Ω–∏—è.")
    elif answers.get('Q2') == 'Q2_A4': # –¢-–∑–æ–Ω–∞ –±–ª–µ—Å—Ç–∏—Ç, –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è —Å—Ç—è–Ω—É—Ç–∞
        type_scores['–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'] += 3
        reasoning.append("–†–∞–∑–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–∂–∏ –Ω–∞ –¢-–∑–æ–Ω–µ –∏ —â–µ–∫–∞—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.")

    # Q3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã
    if answers.get('Q3') == 'Q3_A3':
        type_scores['–∂–∏—Ä–Ω–∞—è'] += 1
        state_scores['—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã'] += 2
    elif answers.get('Q3') == 'Q3_A4':
        type_scores['–∂–∏—Ä–Ω–∞—è'] += 2
        state_scores['—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã'] += 3
        reasoning.append("–í—ã—Ä–∞–∂–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã —á–∞—Å—Ç–æ —Å–≤—è–∑–∞–Ω—ã —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é —Å–∞–ª—å–Ω—ã—Ö –∂–µ–ª–µ–∑.")

    # Q4: –®–µ–ª—É—à–µ–Ω–∏—è
    if answers.get('Q4') == 'Q4_A1':
        state_scores['–æ–±–µ–∑–≤–æ–∂–µ–Ω–Ω–æ—Å—Ç—å'] += 2
        state_scores['—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'] += 1
        reasoning.append("–®–µ–ª—É—à–µ–Ω–∏—è —è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏–∑–Ω–∞–∫–æ–º –Ω–∞—Ä—É—à–µ–Ω–∏—è –∑–∞—â–∏—Ç–Ω–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞ –∏ –æ–±–µ–∑–≤–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏.")

    # Q5: –ù–µ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞ (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä)
    if 'Q5_A1' in answers.get('Q5', []): # –ß–µ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏
        state_scores['—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã'] += 2
        type_scores['–∂–∏—Ä–Ω–∞—è'] += 1
        type_scores['–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'] += 1
    if 'Q5_A2' in answers.get('Q5', []): # –í–æ—Å–ø–∞–ª–µ–Ω–∏—è
        state_scores['–∞–∫–Ω–µ'] += 2
        reasoning.append("–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è –∫ –æ—á–∏—â–µ–Ω–∏—é –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤.")
    
    # Q6: –ü–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è
    if answers.get('Q6') == 'Q6_A2' or answers.get('Q6') == 'Q6_A3':
        state_scores['–ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è'] += 3
        reasoning.append("–ù–∞–ª–∏—á–∏–µ –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SPF –∏ –æ—Å–≤–µ—Ç–ª—è—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.")

    # Q7: –ü–æ—Å—Ç–∞–∫–Ω–µ/–∞–∫–Ω–µ
    if answers.get('Q7') == 'Q7_A2' or answers.get('Q7') == 'Q7_A3':
        state_scores['–ø–æ—Å—Ç–∞–∫–Ω–µ'] += 3
        if answers.get('Q7') == 'Q7_A3':
            state_scores['–∞–∫–Ω–µ'] += 2
        reasoning.append("–°–ª–µ–¥—ã –æ—Ç –∞–∫–Ω–µ (–ø–æ—Å—Ç–∞–∫–Ω–µ) —Ç—Ä–µ–±—É—é—Ç –∞–∫—Ç–∏–≤–æ–≤, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–∂–∏.")

    # Q8: –ú–æ—Ä—â–∏–Ω—ã
    if answers.get('Q8') == 'Q8_A2' or answers.get('Q8') == 'Q8_A3':
        state_scores['–º–æ—Ä—â–∏–Ω—ã'] += 3
        reasoning.append("–ù–∞–ª–∏—á–∏–µ –º–æ—Ä—â–∏–Ω ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∏–µ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∞–Ω—Ç–∏–≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–ø–µ–ø—Ç–∏–¥—ã, —Ä–µ—Ç–∏–Ω–æ–∏–¥—ã).")

    # Q9: –û–±–ª–∞—Å—Ç—å –≤–æ–∫—Ä—É–≥ –≥–ª–∞–∑ (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä)
    if 'Q9_A1' in answers.get('Q9', []):
        state_scores['–æ—Ç–µ–∫–∏'] += 2
    if 'Q9_A2' in answers.get('Q9', []):
        state_scores['—Ç–µ–º–Ω—ã–µ –∫—Ä—É–≥–∏'] += 2
    if 'Q9_A3' in answers.get('Q9', []):
        state_scores['–º–æ—Ä—â–∏–Ω—ã –≤–æ–∫—Ä—É–≥ –≥–ª–∞–∑'] += 2

    # Q11: –¢–æ–Ω –∏ —Ä–µ–ª—å–µ—Ñ
    if answers.get('Q11') == 'Q11_A2': # –¢—É—Å–∫–ª–∞—è
        state_scores['—Ç—É—Å–∫–ª–æ—Å—Ç—å'] += 2
        reasoning.append("–¢—É—Å–∫–ª—ã–π —Ü–≤–µ—Ç –ª–∏—Ü–∞ –≥–æ–≤–æ—Ä–∏—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–∏ –∏ —ç–∫—Å—Ñ–æ–ª–∏–∞—Ü–∏–∏.")
    if answers.get('Q11') == 'Q11_A3': # –ü–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏—è
        state_scores['—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'] += 2
        state_scores['–∫—É–ø–µ—Ä–æ–∑'] += 1
        reasoning.append("–ü–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏—è –∏ —Å–æ—Å—É–¥–∏—Å—Ç—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏ —Ç—Ä–µ–±—É—é—Ç –¥–µ–ª–∏–∫–∞—Ç–Ω–æ–≥–æ —É—Ö–æ–¥–∞ –∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ—Å—É–¥–æ–≤.")
    if answers.get('Q11') == 'Q11_A4': # –†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è
        state_scores['—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'] += 3
        reasoning.append("–ß–∞—Å—Ç—ã–µ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–∂–∏ –∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞.")
        
    # Q12: –ö—É–ø–µ—Ä–æ–∑
    if answers.get('Q12') == 'Q12_A1' or answers.get('Q12') == 'Q12_A2':
        state_scores['–∫—É–ø–µ—Ä–æ–∑'] += 3
        state_scores['—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'] += 2
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ–∂–∏
    # –ï—Å–ª–∏ –±–∞–ª–ª–æ–≤ —É "–∫–æ–º–±–∏" –±–æ–ª—å—à–µ –≤—Å–µ—Ö, —Ç–æ —ç—Ç–æ –æ–Ω–∞.
    # –ò–Ω–∞—á–µ, –µ—Å–ª–∏ —É "–∂–∏—Ä–Ω–æ–π" –∏ "—Å—É—Ö–æ–π" –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω—ã–µ –±–∞–ª–ª—ã - —Ç–æ–∂–µ "–∫–æ–º–±–∏".
    if type_scores['–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'] >= max(type_scores.values()):
        skin_type = '–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'
    elif abs(type_scores['–∂–∏—Ä–Ω–∞—è'] - type_scores['—Å—É—Ö–∞—è']) <= 1 and type_scores['–∂–∏—Ä–Ω–∞—è'] > 1 and type_scores['—Å—É—Ö–∞—è'] > 1:
        skin_type = '–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'
    else:
        # –£–±–∏—Ä–∞–µ–º "–∫–æ–º–±–∏" –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ç–∏–ø
        del type_scores['–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è']
        if not type_scores or max(type_scores.values()) == 0:
            skin_type = '–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è'
        else:
            skin_type = max(type_scores, key=type_scores.get)

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–æ–Ω–∞
    undertone_map = {'Q13_A1': '—Ç—ë–ø–ª—ã–π', 'Q13_A2': '—Ö–æ–ª–æ–¥–Ω—ã–π', 'Q13_A3': '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π'}
    undertone = undertone_map.get(answers.get('Q13'), '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–æ—Ä–∏—Ç–∞
    color_palette = undertone
    if undertone == '—Ö–æ–ª–æ–¥–Ω—ã–π' and answers.get('Q14') in ['Q14_A2', 'Q14_A4']: # –°–∏–Ω–∏–µ/—Å–µ—Ä—ã–µ –≥–ª–∞–∑–∞
        color_palette = "—Ö–æ–ª–æ–¥–Ω–∞—è –≥–∞–º–º–∞"
    elif undertone == '—Ç—ë–ø–ª—ã–π' and answers.get('Q14') in ['Q14_A1', 'Q14_A5']: # –ö–∞—Ä–∏–µ/–æ—Ä–µ—Ö–æ–≤—ã–µ
        color_palette = "—Ç—ë–ø–ª–∞—è –≥–∞–º–º–∞"

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    final_states = [state for state, score in state_scores.items() if score > 0]
    if not final_states:
        final_states.append("—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è")
        
    return {
        "skin_type": skin_type,
        "states": final_states,
        "undertone": undertone,
        "color_palette": color_palette,
        "reasoning": reasoning,
        "uses_retinoids": answers.get('Q10') == 'Q10_A1'
    }

```

#### **\# FILE: .skin-advisor/app/domain/recommender.py**

```python
import json
from pathlib import Path

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –º–æ–¥—É–ª—è
PRODUCTS_PATH = Path(__file__).parent.parent / "data" / "products.json"
with open(PRODUCTS_PATH, 'r', encoding='utf-8') as f:
    PRODUCTS = json.load(f)

def _find_product(category: str, diagnosis: dict, price_tier: str, purpose_keywords: list[str] | None = None, required_actives: list[str] | None = None):
    """
    –ò—â–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.
    """
    candidates = []
    for product in PRODUCTS:
        if product['category'] != category:
            continue
        
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ü–µ–Ω–µ
        if product['price_tier'] != price_tier:
            continue
        
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –∫–æ–∂–∏
        is_type_match = diagnosis['skin_type'] in product['skin_type'] or '–ª—é–±–æ–π' in product['skin_type']
        if not is_type_match:
            continue
            
        # –û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
        score = 0
        if purpose_keywords:
            if any(key in product['purpose'] for key in purpose_keywords):
                score += 5
        
        if required_actives:
            if any(act in product['actives'] for act in required_actives):
                score += 10 # –ê–∫—Ç–∏–≤ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ
        
        # –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º –∫–æ–∂–∏
        state_matches = set(diagnosis['states']) & set(product['skin_state'])
        score += len(state_matches)
        
        if score > 0:
            candidates.append({'product': product, 'score': score})
    
    if not candidates:
        return None, "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ü–µ–Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é."

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –±–∞–ª–ª–æ–º
    best_match = max(candidates, key=lambda x: x['score'])
    return best_match['product'], None


def get_recommendations(diagnosis: dict, price_tier: str) -> dict:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É –∏ –º–∞–∫–∏—è–∂—É.
    """
    routines = {
        'am': [],
        'pm': [],
        'weekly': [],
        'makeup': [],
    }
    warnings = []
    
    # --- AM Routine ---
    # 1. –û—á–∏—â–µ–Ω–∏–µ
    p_clean, _ = _find_product('–æ—á–∏—â–µ–Ω–∏–µ', diagnosis, price_tier, purpose_keywords=['–º—è–≥–∫–æ–µ', '–æ—á–∏—â–µ–Ω–∏–µ'])
    if p_clean: routines['am'].append({'product': p_clean, 'how_to_use': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —É–º—ã–≤–∞–Ω–∏—è —É—Ç—Ä–æ–º.'})
    
    # 2. –°—ã–≤–æ—Ä–æ—Ç–∫–∞ (–í–∏—Ç–∞–º–∏–Ω C –∏–ª–∏ –ù–∏–∞—Ü–∏–Ω–∞–º–∏–¥)
    if '–ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è' in diagnosis['states'] or '—Ç—É—Å–∫–ª–æ—Å—Ç—å' in diagnosis['states']:
        p_serum_am, _ = _find_product('—Å—ã–≤–æ—Ä–æ—Ç–∫–∞', diagnosis, price_tier, required_actives=['–≤–∏—Ç–∞–º–∏–Ω C'])
        if p_serum_am: routines['am'].append({'product': p_serum_am, 'how_to_use': '–ù–∞–Ω–µ—Å–∏—Ç–µ –Ω–∞ —Å—É—Ö—É—é –∫–æ–∂—É –ø–æ—Å–ª–µ –æ—á–∏—â–µ–Ω–∏—è.'})
    
    # 3. –£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ
    p_moist, _ = _find_product('—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ', diagnosis, price_tier, purpose_keywords=['—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ', '–∫—Ä–µ–º'])
    if p_moist: routines['am'].append({'product': p_moist, 'how_to_use': '–ù–∞–Ω–æ—Å–∏—Ç–µ –ø–æ—Å–ª–µ —Å—ã–≤–æ—Ä–æ—Ç–∫–∏ –∏–ª–∏ –Ω–∞ —á–∏—Å—Ç—É—é –∫–æ–∂—É.'})

    # 4. SPF
    p_spf, _ = _find_product('spf', diagnosis, price_tier)
    if p_spf: routines['am'].append({'product': p_spf, 'how_to_use': '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–Ω–æ—Å–∏—Ç–µ –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –∑–∞ 20 –º–∏–Ω—É—Ç –¥–æ –≤—ã—Ö–æ–¥–∞.'})
    else: warnings.append("‚ùó SPF 50+ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ! –í –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–¥—É–∫—Ç, –Ω–æ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ.")

    # --- PM Routine ---
    # 1. –û—á–∏—â–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ –∂–µ, —á—Ç–æ –∏ —É—Ç—Ä–æ–º)
    if p_clean: routines['pm'].append({'product': p_clean, 'how_to_use': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —É–º—ã–≤–∞–Ω–∏—è –≤–µ—á–µ—Ä–æ–º. –ï—Å–ª–∏ –Ω–æ—Å–∏—Ç–µ –º–∞–∫–∏—è–∂ - —ç—Ç–æ –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –ø–æ—Å–ª–µ –≥–∏–¥—Ä–æ—Ñ–∏–ª—å–Ω–æ–≥–æ –º–∞—Å–ª–∞/–±–∞–ª—å–∑–∞–º–∞.'})

    # 2. –ê–∫—Ç–∏–≤ (–†–µ—Ç–∏–Ω–æ–∏–¥—ã/–ö–∏—Å–ª–æ—Ç—ã)
    active_product = None
    if '–∞–∫–Ω–µ' in diagnosis['states'] or '–ø–æ—Å—Ç–∞–∫–Ω–µ' in diagnosis['states'] or '–º–æ—Ä—â–∏–Ω—ã' in diagnosis['states']:
        p_ret, _ = _find_product('–∞–∫—Ç–∏–≤', diagnosis, price_tier, required_actives=['—Ä–µ—Ç–∏–Ω–∞–ª—å', '—Ä–µ—Ç–∏–Ω–æ–ª'])
        if p_ret:
            active_product = p_ret
            routines['pm'].append({'product': p_ret, 'how_to_use': '–ù–∞–Ω–æ—Å–∏—Ç–µ –Ω–∞ —Å—É—Ö—É—é –∫–æ–∂—É 2-3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—è —á–∞—Å—Ç–æ—Ç—É.'})
            warnings.append("‚ö†Ô∏è –ù–∞—á–∏–Ω–∞–π—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ä–µ—Ç–∏–Ω–æ–∏–¥—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é), —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–µ–∞–∫—Ü–∏–µ–π –∫–æ–∂–∏.")
            warnings.append("–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—Ç–∏–Ω–æ–∏–¥—ã –≤ –æ–¥–∏–Ω –≤–µ—á–µ—Ä —Å –∫–∏—Å–ª–æ—Ç–Ω—ã–º–∏ –ø–∏–ª–∏–Ω–≥–∞–º–∏.")
    
    # 3. –£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ (–≤–µ—á–µ—Ä)
    if p_moist: routines['pm'].append({'product': p_moist, 'how_to_use': '–ù–∞–Ω–æ—Å–∏—Ç–µ —á–µ—Ä–µ–∑ 20-30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞ –∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—á–∏—â–µ–Ω–∏—è –≤ —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ—Ç –∞–∫—Ç–∏–≤–æ–≤ –¥–Ω–∏.'})

    # --- Weekly Routine ---
    p_weekly, _ = _find_product('–º–∞—Å–∫–∞', diagnosis, price_tier, purpose_keywords=['—ç–Ω–∑–∏–º–Ω–∞—è', '–∫–∏—Å–ª–æ—Ç–Ω–∞—è', '–æ—á–∏—â–∞—é—â–∞—è'])
    if p_weekly: routines['weekly'].append({'product': p_weekly, 'how_to_use': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –Ω–∞ –æ—á–∏—â–µ–Ω–Ω—É—é –∫–æ–∂—É.'})

    # --- Makeup ---
    if diagnosis['skin_type'] in ['–∂–∏—Ä–Ω–∞—è', '–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è']:
        p_base, _ = _find_product('—Ç–æ–Ω', diagnosis, price_tier, purpose_keywords=['—Å—Ç–æ–π–∫–æ–µ', '–º–∞—Ç–∏—Ä—É—é—â–µ–µ'])
    else:
        p_base, _ = _find_product('—Ç–æ–Ω', diagnosis, price_tier, purpose_keywords=['—É–≤–ª–∞–∂–Ω—è—é—â–µ–µ', '–ª–µ–≥–∫–æ–µ'])
    if p_base: routines['makeup'].append({'product': p_base, 'how_to_use': f"–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–∏–ø–∞ –∫–æ–∂–∏. –í—ã–±–∏—Ä–∞–π—Ç–µ –æ—Ç—Ç–µ–Ω–æ–∫, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–∞—à–µ–º—É –ø–æ–¥—Ç–æ–Ω—É ({diagnosis['undertone']})."})

    p_lips, _ = _find_product('–≥—É–±—ã', diagnosis, price_tier)
    if p_lips: routines['makeup'].append({'product': p_lips, 'how_to_use': f"–ü–æ–¥–±–∏—Ä–∞–π—Ç–µ –æ—Ç—Ç–µ–Ω–∫–∏ –∏–∑ –≤–∞—à–µ–π —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∞–ª–∏—Ç—Ä—ã ({diagnosis['color_palette']})."})

    return {'routines': routines, 'warnings': warnings}

```

#### **\# FILE: .skin-advisor/app/ui/keyboards.py**

```python
import json
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫
with open('app/i18n/ru.json', 'r', encoding='utf-8') as f:
    LEXICON = json.load(f)

def set_main_menu() -> ReplyKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏."""
    builder = ReplyKeyboardBuilder()
    builder.row(
        KeyboardButton(text=LEXICON['btn_start_survey']),
        KeyboardButton(text=LEXICON['btn_results']),
        KeyboardButton(text=LEXICON['btn_recommendations']),
    )
    builder.row(
        KeyboardButton(text=LEXICON['btn_navigation']),
        KeyboardButton(text=LEXICON['btn_reset'])
    )
    return builder.as_markup(resize_keyboard=True)

def create_nav_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."""
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text=LEXICON['btn_help'], callback_data='nav_help'),
        InlineKeyboardButton(text=LEXICON['btn_policy'], callback_data='nav_policy')
    )
    return builder.as_markup()

def create_survey_keyboard(question_id: str, options: dict, is_multi: bool = False) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ –∞–Ω–∫–µ—Ç—ã."""
    builder = InlineKeyboardBuilder()
    for key, value in options.items():
        builder.add(InlineKeyboardButton(text=value, callback_data=f'survey:{question_id}:{key}'))
    
    if is_multi:
        builder.add(InlineKeyboardButton(text=LEXICON['btn_next'], callback_data=f'survey:{question_id}:next'))
    
    builder.adjust(1)
    return builder.as_markup()


def create_confirm_keyboard(callback_data: str, text: str) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."""
    builder = InlineKeyboardBuilder()
    builder.add(InlineKeyboardButton(text=text, callback_data=callback_data))
    return builder.as_markup()
    
def create_results_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏."""
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text=LEXICON['btn_get_recommendations'], callback_data='action:get_recs'),
        InlineKeyboardButton(text=LEXICON['btn_download_pdf'], callback_data='action:get_pdf')
    )
    builder.row(
        InlineKeyboardButton(text=LEXICON['btn_change_answers'], callback_data='action:reset')
    )
    return builder.as_markup()

def create_price_tier_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."""
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text=LEXICON['btn_budget'], callback_data='price:budget'),
        InlineKeyboardButton(text=LEXICON['btn_mid'], callback_data='price:mid'),
        InlineKeyboardButton(text=LEXICON['btn_premium'], callback_data='price:premium')
    )
    return builder.as_markup()

def create_links_keyboard(product: dict) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã."""
    builder = InlineKeyboardBuilder()
    from app.infra.settings import get_settings
    settings = get_settings()
    
    for marketplace_name in settings.app.marketplaces:
        if url := product.get("links", {}).get(marketplace_name):
            builder.add(InlineKeyboardButton(text=f'üõí {marketplace_name}', url=url))
            
    builder.adjust(1)
    return builder.as_markup()
```

#### **\# FILE: .skin-advisor/app/ui/messages.py**

```python
import json
from app.infra.links import generate_product_links
from app.infra.settings import get_settings

with open('app/i18n/ru.json', 'r', encoding='utf-8') as f:
    LEXICON = json.load(f)

def get_welcome_message(user_name: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    return LEXICON['welcome'].format(user_name=user_name)

def get_help_message() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–º–æ—â–∏."""
    return LEXICON['help_text']
    
def get_privacy_message() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏."""
    settings = get_settings()
    return LEXICON['privacy_text'].format(
        days=settings.app.data_retention_days,
        url=settings.app.privacy_policy_url
    )

def format_diagnosis_result(result: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    states_str = ", ".join(result.get('states', ['–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã']))
    
    text = (
        f"<b>‚úÖ –í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</b>\n\n"
        f"<b>–¢–∏–ø –∫–æ–∂–∏:</b> {result.get('skin_type', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω').capitalize()}\n"
        f"<b>–°–æ—Å—Ç–æ—è–Ω–∏—è:</b> {states_str.capitalize()}\n"
        f"<b>–ü–æ–¥—Ç–æ–Ω:</b> {result.get('undertone', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω').capitalize()}\n\n"
        f"<b>–ü–æ—á–µ–º—É –º—ã —Ç–∞–∫ —Ä–µ—à–∏–ª–∏ (–æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã):</b>\n"
    )
    for reason in result.get('reasoning', [])[:3]: # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 3 –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
        text += f"‚Ä¢ <i>{reason}</i>\n"
        
    return text

def format_recommendations(recs: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    settings = get_settings()
    text = ""
    
    routines = recs.get('routines', {})
    
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    titles = {
        'am': '‚òÄÔ∏è <b>–£—Ç—Ä–µ–Ω–Ω–∏–π —É—Ö–æ–¥ (AM)</b>',
        'pm': 'üåô <b>–í–µ—á–µ—Ä–Ω–∏–π —É—Ö–æ–¥ (PM)</b>',
        'weekly': '‚ú® <b>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —É—Ö–æ–¥ (1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é)</b>',
        'makeup': 'üíÑ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞–∫–∏—è–∂—É</b>'
    }

    for key, title in titles.items():
        if routine_steps := routines.get(key):
            text += f"{title}\n"
            for i, step in enumerate(routine_steps):
                product = step['product']
                how_to_use = step['how_to_use']
                links = generate_product_links(product)
                
                text += (
                    f"<b>{i+1}. {product['name']} ({product['brand']})</b>\n"
                    f"<i>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</i> {product['purpose']}\n"
                    f"<i>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</i> {how_to_use}\n"
                    f"{'üõí ' + links if links else ''}\n\n"
                )
            text += "\n"

    if warnings := recs.get('warnings'):
        text += "‚ö†Ô∏è <b>–í–∞–∂–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
        for warning in warnings:
            text += f"‚Ä¢ <i>{warning}</i>\n"
        text += "\n"
        
    text += f"\n{settings.app.disclaimer}"
    
    return text
```

#### **\# FILE: .skin-advisor/app/handlers/start.py**

```python
from aiogram import Router, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession

from app.infra.models import User
from app.ui import keyboards, messages

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message, session: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î
    user = await session.get(User, message.from_user.id)
    if not user:
        new_user = User(
            user_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name
        )
        session.add(new_user)
        await session.commit()
    
    await message.answer(
        messages.get_welcome_message(message.from_user.first_name),
        reply_markup=keyboards.set_main_menu()
    )

@router.message(F.text == messages.LEXICON['btn_navigation'])
@router.message(Command("help", "privacy"))
async def cmd_navigation(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –∫–æ–º–∞–Ω–¥ –ø–æ–º–æ—â–∏/–ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏."""
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", reply_markup=keyboards.create_nav_keyboard())

@router.callback_query(F.data == 'nav_help')
async def cb_help(callback: CallbackQuery):
    await callback.message.edit_text(messages.get_help_message())
    await callback.answer()

@router.callback_query(F.data == 'nav_policy')
async def cb_policy(callback: CallbackQuery):
    await callback.message.edit_text(messages.get_privacy_message())
    await callback.answer()

```

... –ò –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏\! –ú—ã –ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏.